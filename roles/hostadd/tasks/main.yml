---
# tasks to add host to tower inventory
#
- name: Add tower inventory
  tower_inventory:
    name: "{{ inventory }}"
    description: "off-net hosts inventory"
    organization: "{{ organization }}"
    variables: "---"
    state: present
    tower_verify_ssl: False
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"

- name: Add host to tower inventory
  tower_host:
    name: "{{ remote_hostname }}"
    description: "off-net host {{ remote_hostname }}"
    inventory: "{{ inventory }}"
    variables: "---\nansible_host:{{ remote_ipv4 }}\nansible_port:{{ remote_port }}"
    state: present
    tower_verify_ssl: False
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"

- name: Create local private key directory
  file:
    path: "/tmp/3ADE68B1-75BCD15/{{ remote_hostname }}"
    state: directory

- name: Create local private key file
  template:
    src: decoded_key.j2
    dest: "/tmp/3ADE68B1-75BCD15/{{ remote_hostname }}/KEY"

- name: Add host credential to tower
  tower_credential:
    name: "{{ remote_hostname }}"
    description: "off-net host {{ remote_hostname }}"
    organization: "{{ organization }}"
    kind: ssh
    username: "{{ username }}"
    ssh_key_data: "/tmp/3ADE68B1-75BCD15/{{ remote_hostname }}/KEY"
    state: present
    tower_verify_ssl: False
    credential_type: "{{ credential_type }}"
    tower_host: "{{ tower_host }}"
    tower_username: "{{ tower_username }}"
    tower_password: "{{ tower_password }}"

- name: Remove local private key directory
  file:
    path: "/tmp/3ADE68B1-75BCD15/{{ remote_hostname }}"
    state: absent
